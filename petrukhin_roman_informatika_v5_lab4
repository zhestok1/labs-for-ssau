#include <iostream>
#include <fstream>
#include <sstream>
#include <map>
#include <string>
#include <limits>
#include <stdexcept>

using namespace std;

void word_index(const map<string, int>& dictionary, const string& filename) {
    ofstream outFile(filename);
    if (outFile) {
        for (const auto& pair : dictionary) {
            outFile << pair.first << " " << pair.second << endl;
        }
    }
    else {
        cerr << "Не удалось открыть файл " << filename << " для записи." << endl;
    }
}

void archive(const string& inputFile, const string& outputFile) {
    ifstream inFile(inputFile);
    if (!inFile) {
        cerr << "Не удалось открыть файл " << inputFile << " для чтения." << endl;
        return;
    }

    map<string, int> dictionary;
    string word;
    int index = 0;

    while (inFile >> word) {
        if (dictionary.find(word) == dictionary.end()) {
            dictionary[word] = index++;
        }
    }

    word_index(dictionary, "logs.txt");

    ofstream outFile(outputFile);
    if (!outFile) {
        cerr << "Не удалось открыть файл " << outputFile << " для записи." << endl;
        return;
    }

    for (const auto& pair : dictionary) {
        outFile << pair.second << endl; // Записываем индексы слов для архивации
    }

    outFile.close();
}

void dearchive(const string& inputFile, const string& outputFile) {
    ifstream inFile("logs.txt");
    if (!inFile) {
        cerr << "Не удалось открыть файл logs.txt для чтения." << endl;
        return;
    }

    map<int, string> reverseDictionary;
    string line;
    int index;

    while (getline(inFile, line)) {
        istringstream str(line);       
        string word;
        getline(str, word); // Считываем слово 
        str >> index; // Считываем индекс из потока
        reverseDictionary[index] = word; // Добавляем в обратный словарь
    }

    inFile.close();

    ifstream indexFile(inputFile);
    if (!indexFile) {
        cerr << "Не удалось открыть файл " << inputFile << " для чтения индексов." << endl;
        return;
    }

    ofstream outFile(outputFile);
    if (!outFile) {
        cerr << "Не удалось открыть файл " << outputFile << " для записи." << endl;
        return;
    }

    while (getline(indexFile, line)) {
        try {
            index = stoi(line);
            if (reverseDictionary.find(index) != reverseDictionary.end()) {
                outFile << reverseDictionary[index] << endl;
            }
            else {
                cerr << "Индекс " << index << " не найден в словаре." << endl;
            }
        }
        catch (const invalid_argument& e) {
            cerr << "Ошибка преобразования: " << e.what() << " для строки " << line << endl;
        }
    }

    outFile.close();
}

int main() {
    setlocale(LC_ALL, "ru");
    string filename;
    char answer;

    cout << "Введите имя файла: ";
    cin >> filename;

    cout << "Выберите действие: \n1 - Архивация\n2 - Дехврахивация\nВведите 1 или 2: ";
    cin >> answer;

    switch (answer) {
    case '1':
        archive(filename + ".txt", filename + ".txt");
        cout << "Файл успешно заархивирован." << endl;
        break;
    case '2':
        dearchive(filename + ".txt", filename + ".txt");
        cout << "Файл успешно деархивирован." << endl;
        break;
    default:
        cout << "Неверный выбор. Пожалуйста, введите 1 или 2." << endl;
        break;
    }

    return 0;
}
